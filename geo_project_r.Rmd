---
title: "geo_project"
author: "Ng Jia Wen"
date: "28/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
               cache=TRUE, autodep=TRUE, cache.comments=FALSE,
               message=FALSE, warning=FALSE)
setwd("~/Documents/UCL/Term_1/SAG/geo_project")
```

```{r}
# Load libraries
library(leaflet)
library(sp)
library(dplyr)
library(mapview)
library(ggplot2)
library(rgdal)
library(spgwr)
library(gstat)
library(spdep)
library(spatstat)
library(maptools)
```

```{r}
# load necessary data
load("boundaries/LondonLSOA")
load("boundaries/LondonWards")
projection <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
LondonWards <- spTransform(LondonWards, projection)
LondonLSOA <- spTransform(LondonLSOA, projection)
load("df.Rda") #crime df
```

### Exploratory Plots
```{r}
# Plot barplot of crime type
par(mar=c(15,6,4,1)+.1)
barplot(table(df$Crime.type), main='London Crimes', xlab='Crime Type',ylab='Count',las =2)

# Plot line chart crime x month
crime_count_by_month <-data.frame(table(df$Month, df$Crime.type)) 
names(crime_count_by_month) <- c("Month", "Crime.type","Freq")

ggplot(crime_count_by_month, aes(x = Month, y = Freq, colour = Crime.type, group=Crime.type), main='Crime Count by Type')+
  geom_line()+
  geom_point()+ 
  ggtitle("Crime Count in London")

# Plot line chart without ASB and Violence
crime_count_wo_ASB_V <- crime_count_by_month[!(crime_count_by_month$Crime.type=='Anti-social behaviour' |crime_count_by_month$Crime.type=='Violence and sexual offences'),]

ggplot(crime_count_wo_ASB_V, aes(x = Month, y = Freq, colour = Crime.type, group=Crime.type), main='Crime Count by Type')+
  geom_line()+
  geom_point()+ 
  ggtitle("Crime Count in London")

# Plot Mosaicplot
mosaicplot(main='Crime Proportions', table(df$Month, df$Crime.type))

```

### Get Crime Density Count Map By LSOA
```{r}
LondonLSOA_transformed <- LondonLSOA
# get crime count by LSOA
crimenum_by_LSOA <- data.frame(table(df$LSOA.name)) %>% na.omit()
crimenum_by_LSOA$Var1 <- as.character(crimenum_by_LSOA$Var1)
crimenum_by_LSOA <- crimenum_by_LSOA[!apply(crimenum_by_LSOA, 1, function(x) any(x=="")),] 

# get combined boundary + LSOA crime count data
LondonLSOA_transformed@data <- left_join(LondonLSOA_transformed@data, crimenum_by_LSOA, by=c("LSOA11NM"="Var1"))

# colour LSOA based on frequency values
pal <- colorNumeric(
  palette = "Blues",
  domain = LondonLSOA_transformed$Freq)
# colour LSOA based on colourquantiles
qpal <- colorQuantile("Blues", LondonLSOA_transformed$Freq, n = 5)
# colour LSOA based on bins
binpal <- colorBin("Blues", LondonLSOA_transformed$Freq, 3, pretty = TRUE)

# Plot crime map based on count density 
LSOA_crimemap <- leaflet(LondonLSOA_transformed, width = "100%")%>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1,
    color = ~qpal(Freq)) %>% 
  addPolygons(data=LondonLSOA_transformed, weight = 0.1, fillOpacity = 0,popup = paste("Region: ", LondonLSOA_transformed$LSOA11NM, "<br>",
                          "Value: ", LondonLSOA_transformed$Freq, "<br>")) %>% 
  addLegend(pal =qpal, values = LondonLSOA_transformed$Freq, opacity = 1, labFormat = function(type, cuts, p) {
    n = length(cuts)
    paste0(cuts[-n], " &ndash; ", cuts[-1])
  })

LSOA_crimemap
```

### Violence and Sexual Offences  
Violence and sexual offences (VSO) crime is chosen as it is one of the more severe crimes that bring about damage to people and property. Violence includes murder, kidnap, etc hence the level of severity of this nature of crime can be high. We want to understand more about these types of crimes in order to help understand and possibly predict the factors that contribute to this crime type.   

```{r}
# Get violence and sexual offences crimes only
vs_df <- subset(df, Crime.type == 'Violence and sexual offences')
vs_df <- vs_df[!is.na(vs_df$Longitude),]
vs_df <- vs_df[!is.na(vs_df$Latitude),]
```

If we plot a year's worth of VSO on a map, we would get the following result:   
```{r}
# Violence and Sexual Offences Map 
vs_dot_map <- leaflet(vs_df) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>%
  addCircleMarkers(radius =1, color = 'red', stroke = FALSE, fillOpacity = 0.5)

vs_dot_map

```
This map is not very helpful in telling us much information about the crime nature. Hence, we employ some methods in point pattern analysis to help us understand more. 

### Point Pattern Analysis
```{r}
# get ppp file
london_shape <- readOGR('boundaries/greaterlondon.geojson')
vs_spatial_points <-  vs_df
coordinates(vs_spatial_points) <- ~Longitude+Latitude
pts <- coordinates(vs_spatial_points)
londonOwin <- as.owin(london_shape)
vs_ppp <- ppp(pts[,1],pts[,2], window=londonOwin)

# ggplot(data=vs_LSOA@data, aes(vs_LSOA$Freq)) + geom_histogram() + ggtitle('Violence and Sexual Assault Crimes in 2017') + ylab('Number of LSOAs') + xlab('Violence and Sexual Offences Occurrence')
```

Looking at the density plot below, we see that VSO is the most dense in the central part of London.
```{r}
# density plot
ds <- density(vs_ppp)
plot(ds, main='Violence and Sexual Offences')
```

To test for spatial clustering, we run ripley's K function and it indicates that there is a high level of clustering for VSO. 
```{r}
# ripley's k function
ktest <- Kest(vs_ppp)
plot(ktest)
```

However, this result is not very helpful. The sheer number of cases in central london as compared to everywhere else, skews ripley's K function -- there is clustering and the clustering happens in central london.   

We could perhaps analyse VSO by LSOAs to ensure that the crime density is contained. 

### Analysing by LSOA
```{r}
# Clean Data
vs_LSOA <- LondonLSOA
vs_num_by_LSOA <- data.frame(table(vs_df$LSOA.name)) %>% na.omit()
vs_num_by_LSOA$Var1 <- as.character(vs_num_by_LSOA$Var1)
vs_num_by_LSOA <- vs_num_by_LSOA[!apply(vs_num_by_LSOA, 1, function(x) any(x=="")),]
vs_LSOA@data<- left_join(vs_LSOA@data, vs_num_by_LSOA, by=c("LSOA11NM"="Var1"))
```

Plotting VSO by LSOA, we get the following map:  
```{r}
# Plot map
cc_colors <- c('#FFE80C','#FF7700','#E81501')
cc_pal <- colorBin(
  palette = cc_colors,
  bins = c(0,10,100,2000),
  na.color='black')

pop_up_text = paste("Region: ", vs_LSOA$LSOA11NM, "<br>",
                          "Value: ", vs_LSOA$Freq, "<br>")

vs_LSOA_map <- leaflet(vs_LSOA) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1,
    color = ~cc_pal(Freq), popup = pop_up_text) %>% 
  addLegend("bottomright", 
    colors= cc_colors, 
    labels=c('0-10', "10-100","100-2000"),
    opacity= 1)

vs_LSOA_map
```
From this map, it is clear that only certain LSOAs have a high VSO count. Many of them are in central london, but it is not as widespread as in the previous map. We can also see an obvious outlier in the far left of London -- Hillingdon. 

```{r}
load("lsoa_census.Rda")
vs_census <-  vs_LSOA
vs_census@data <- left_join(vs_census@data, lsoa_census, by=c("LSOA11CD" = "Codes"))
vs_census$total_pop <- vs_census$X0.15 + vs_census$X16.29 + vs_census$X30.44 + vs_census$X45.64 + vs_census$X65.

vs_census$freq_pop <-  vs_census$Freq / vs_census$total_pop * 1000 #crime per 1000 people

binpal <- colorBin("Blues", vs_census$freq_pop, 3, pretty = FALSE)

# Plot map
cc_colors <- c('#FFA2A2','#FF7676','#C11010')
cc_pal <- colorBin(
  palette = cc_colors,
  bins = c(0,20,40,1000),
  na.color='black')

pop_up_text = paste("Region: ", vs_census$LSOA11NM, "<br>",
                          "Value: ", vs_census$freq_pop, "<br>")

vs_LSOA_crime_pop_map <- leaflet(vs_census) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1,
    color = ~cc_pal(freq_pop), popup = pop_up_text) %>% 
  addLegend("bottomright",
    title = 'Crime Count per 1000 people',
    colors= cc_colors, 
    labels=c('0-20', "20-40","40-700"),
    opacity= 1)

vs_LSOA_crime_pop_map

```
#### Just City of London 001F ####
```{r}
top_10 <-  data.frame(vs_census@data[order(-vs_census$freq_pop)[1:20], "Names"])
top_10$freq_pop <- vs_census@data[order(-vs_census$freq_pop)[1:20], "freq_pop"]

COL001F_shp <- vs_LSOA[vs_LSOA$LSOA11NM == 'City of London 001F',]

## plot points of occurrence
COL001F_ll <- vs_df[vs_df$LSOA.name == 'City of London 001F',]
COL001F_ll <- subset(COL001F_ll, select=c("Longitude", "Latitude"))
points <- SpatialPoints(COL001F_ll)
plot(COL001F_shp)
plot(points, add= TRUE , col = 'red', pch = 16)



H031A_shp <- vs_LSOA[vs_LSOA$LSOA11NM == 'Hillingdon 031A',]
H031A_ll <- vs_df[vs_df$LSOA.name == 'Hillingdon 031A',]
H031A_ll <- subset(H031A_ll, select=c("Longitude", "Latitude"))

H031A_map <- leaflet(H031A_ll) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(radius = 1, color = 'blue') %>% 
  addPolygons(data = H031A_shp, weight = 1) 

H031A_map


# plot kernel density plot 
COL001F_latlong <- vs_df[vs_df$LSOA.name == 'City of London 001F',]
coordinates(COL001F_latlong) <- ~Longitude+Latitude
pts <- coordinates(COL001F_latlong)
COL001F_Owin <- as.owin(COL001F_shp)
COL001F_ppp <- ppp(pts[,1],pts[,2], window=COL001F_Owin)
COL001F_den <- density(COL001F_ppp)
plot(COL001F_den, main='City of London 001F')

# Do they mostly occur on roads?
# If on roads, is it on public transport -- buses and tubes?
# Do they mostly occur near pubs?
# Do they mostly occur near transport interchanges? (tube stations) https://www.doogal.co.uk/london_stations.php
#https://mapcruzin.com/free-england-arcgis-maps-shapefiles.htm

# plot with background
london_stns <- read.csv('boundaries/London stations.csv')
pubs <- readOGR("data/pubs.geojson", "OGRGeoJSON",require_geomType="wkbPoint")
roads <- readOGR("boundaries/england-roads-shape/roads.shp")
COL001F_map <- leaflet(COL001F_ll) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -0.090900, lat = 51.511751, zoom = 14)%>%
  addCircleMarkers(radius = 1, color = 'blue') %>% 
  addPolygons(data = COL001F_shp, weight = 1) %>% 
  addCircleMarkers(data = london_stns, radius = 1, color = 'yellow', opacity = 1) %>% 
  addCircleMarkers(data = pubs, radius = 1, color = 'red')

COL001F_map

```

### Analysing Factors that Contribute to VSO
```{r}
### Clean census data
#https://data.london.gov.uk/dataset/lsoa-atlas
# lsoa_census <- read.csv('data/lsoa_data_edited.csv')
# lsoa_census$house_price <- as.numeric(lsoa_census$house_price)
# lsoa_census_2 <- read.csv('data/lsoa_data_edited_2.csv')
# lsoa_census <- left_join(lsoa_census, lsoa_census_2, by=c("Codes"="Codes",
#                                                           "Names" = "Names"))
# save(lsoa_census,file="lsoa_census.Rda")
load("lsoa_census.Rda")
vs_census <-  vs_LSOA
vs_census@data <- left_join(vs_census@data, lsoa_census, by=c("LSOA11CD" = "Codes"))
vs_census.W <- nb2listw(poly2nb(vs_census))

# run durbin model
vs.durbin <- lagsarlm(Freq ~ X0.15 + X16.29 + X30.44 + X45.64 + X65. + Working.age + person_per_hectare + couple_w_children + white + uk_born + household_no_english + Christian + Buddhist + Hindu + Jewish + Muslim + Sikh + other_religion + no_religion + owned_outright + social_rented + private_rented + household_at_least_one_usual_resident + household_no_usual_resident + whole_house + apartment + house_price + unemployment_rate + bad_health + no_cars_in_household + poor_transport_access + household_income, data = vs_census@data, listw = vs_census.W, type = 'mixed')

summary(vs.durbin)
```
**Here are the results**
Significant and negatively correlated:  
X0.15, X16.29, X45.64, X65, person_per_hectare, owned_outright, household_at_least_one_usual_resident, apartment, poor_transport_access                    

Significant and positively correlated:  
Christian, Buddhist, Hindu, Jewish, Muslim, no_religion, private-rented, household_no_usual_resident, unemployment_rate , no_cars_in_household , household_income                                         
### Extra code below 

### Map pubs in london
```{r}
library("raster")
library("sp")
pubs <- readOGR("data/pubs.geojson", "OGRGeoJSON",require_geomType="wkbPoint")
pubs <- spTransform(pubs, CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0"))

plot(LondonLSOA)
plot(pubs, col="red" , add=TRUE)
l <- LondonLSOA
l@data <- subset(l@data,select=c('LSOA11NM'))
res <- sp::over(pubs, l)

res <- poly.counts(pubs,LondonLSOA)
setNames(res, LondonLSOA@data$lala)

pubs <- readOGR("data/pubs.geojson", "OGRGeoJSON",require_geomType="wkbPoint")
map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "Base") %>%
  addCircleMarkers(
    data = pubs,
    radius = 1,
    color = "red",
    stroke = TRUE, fillOpacity = 1)

map
```
![](outputs/GIFs/all_gifs/Anti-social behaviour.gif)

### Create Maps for GIF
```{r}
months <- c("2017-01","2017-02","2017-03","2017-04","2017-05","2017-06","2017-07","2017-08","2017-09","2017-10","2017-11","2017-12")

crime_types <- unique(df$Crime.type)

for (crime_type in crime_types){
  for (month in months){
  single_crime_df <- subset(df, Crime.type == crime_type & Month == month)
  single_crime_map <- leaflet(single_crime_df, width = "100%")%>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>%
  addCircleMarkers(radius =1, color = 'red', stroke = FALSE, fillOpacity = 0.5) %>%
  addLabelOnlyMarkers(lng = -0.5, lat = 51.7, label = month,
                      labelOptions = labelOptions(noHide = T, textOnly = T,style = list(
        "color" = "black",
        "font-family" = "source sans pro",
        "font-style" = "bold",
        "font-size" = "20px",
        "border-color" = "rgba(0,0,0,0.5)"
      )))
  path <- sprintf("/GIFs/%s/%s_%s.png", crime_type, crime_type,month)
  print(path)
  mapshot(single_crime_map, file = paste0(getwd(), path, sep=""))
}
}

```

### Create GIFs
```{r}

library(purrr)
library(magick)

crime_types <- unique(df$Crime.type)

for (crime_type in crime_types){
  file_path = paste0(getwd(), sprintf("/GIFs/%s", crime_type), sep="")
  list.files(path = file_path, pattern = "*.png", full.names = T) %>%
    map(image_read) %>% # reads each path file
    image_join() %>% # joins image
    image_animate(fps=2) %>% # animates, can opt for number of loops
    image_write(sprintf("%s.gif",crime_type)) # write to current dir
}

```


### Clean Data
```{r}
# Load crime and boundary data
COL_data <- read.csv(file=paste(getwd(),'/data/COL_street.csv',sep=''), header=TRUE, sep="\t")
metro_data <- read.csv(file=paste(getwd(),'/data/metro_street.csv',sep=''), header=TRUE, sep="\t")
data <- rbind(COL_data, metro_data)
load("boundaries/LondonLSOA")
load("boundaries/LondonWards")
projection <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
LondonWards <- spTransform(LondonWards, projection)
LondonLSOA <- spTransform(LondonLSOA, projection)

# get crime df
df <- subset(data, select=c("Crime.type", "LSOA.name","Longitude","Latitude","Month"))
save(df,file="df.Rda")
```
