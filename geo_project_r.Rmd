---
title: "Spatial Analysis of Crime Patterns in London"
author: "Ng Jia Wen & Junju Ng"
date: "28/10/2018"
output:
  bookdown::pdf_document2:
    number_sections: true
    keep_tex: yes
    toc: true
  bookdown::html_document2:
    number_sections: true
    keep_tex: yes
    toc: true
    theme: united
bibliography: library.bib
biblio-style: apalike
always_allow_html: yes
link-citations: yes
editor_options: 
  chunk_output_type: console
---

\pagebreak

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
               cache=TRUE, autodep=TRUE, cache.comments=FALSE,
               message=FALSE, warning=FALSE)

library(knitr)
knitr::opts_chunk$set(fig.pos = '!h')
#setwd("~/Documents/UCL/Term_1/SAG/geo_project")

```

```{r}
### Load libraries ###
# mapping libraries 
library(leaflet)
library(mapview)
library(ggplot2)
library(maptools)
library(tmaptools)
library(tmap)

# for manipulating spatial data
library(sp)
library(dplyr)
library(rgdal)
library(spgwr)
library(geoR)
library(osmar) 
library(geosphere)
library(rgeos)
library(osmdata)
library(GISTools)
library(sf)

# for analysis
library(gstat)
library(spdep)
library(spatstat)

# for rmarkdown
#library(knitr)
library(bookdown)
#library(tinytex)



```

\pagebreak

# Introduction  
Crime (and its prevention and responses) is associated with significant social and economic costs. In England and Wales, the total cost of crimes against individuals and businesses is £50.1 billion and £8.7 billion respectively in 2015/16 alone [@Brand2014]. A significant portion of these costs are incurred in London, given that about 20% of crimes in England and Wales occurs in London [@MayorofLondon2016]. 

Consequently, much work has been done to understand the occurrence of crime, and to predict crime. To date, the spatial concentration of crime in cities is well-established in the literature [@Malleson2016]. [@Sherman1989]'s seminal analysis of predatory crime in Minneapolis revealed that 50% of police calls come from 3% of street segments, indicating that crime hotspots, down to the street level, are present within cities. Recent works have thus focussed on trying to improve spatial analysis techniques for crime. Specifically, [@Chainey2008] examined the use of different hotspot mapping techniques to predict spatial patterns of crime in Camden and Islington local authority district areas in London. Other researchers have been working on developing techniques to examine spatial-temporal patterns of crime [@Cheng2012], in order to understand how crime develops and evolves to improve crime prediction. 

Given that a significant portion of crimes occurs in London and the occurrence of crime is non-random, this study will therefore examine spatial crime patterns in London. Specifically, this study aims to answer two main questions: 1) where do crime types occur? 2) what factors are associated with the occurrence of different types of crime? 

**Study area**

London is a thriving metropolis in the United Kingdom with a population of 8.8 million. Beyond the large residential population, London also attracts a huge number of visitors, with more than 56 million overnight stays from tourists in 2016 [@MayorofLondon2016]. 

London consists of 33 local government districts (32 London Boroughs and the City of London). The City of London Police is the police force responsible for law enforcement within the City of London while the Metropolitan Police Service is reponsible for policing the Greater London region, excluding the City of London. Greater London can be split into 4835 geographic regions known as lower layer super output areas(LSOAs) for the purposes of reporting small-area statistics. These LSOAs will form the basis of the analysis.

![Boroughs of London](pictures/London.png){width=500px}
\pagebreak

# Data description  
Official geocoded crime data from London is required to analyse spatial patterns of crime. Crime data in London for a one-year period (1 January 2017 to 31 December 2017) from the Metropolitan Police and the City of London Police was used. These data are taken from the Metropolitan Police and the City of London Police because they are the two police forces covering the London and Greater London area. The data was obtained via the police.uk website as a CSV file. Whilst most crimes are geocoded, some reported crimes do not have a location and are therefore excluded from the analysis. The effect on excluding crimes without locations from the analysis is anticipated to be minimal, as they only form a small proportion of reported crimes (5.3% for the City of London Police, and 1.2% for the Metropolitan Police).

The geocoded crime data are categorised into 14 crime types: anti-social behaviour, bicycle theft, burglary, criminal damage and arson, drugs, other crime, other theft, possession of weapons, public order, robbery, shoplifting, theft from a person, vehicle crime, and violence and sexual offences. Geomasking techniques are applied to the data to reduce their spatial accuracy for privacy purposes. Specifically, each crime is mapped to its nearest map point on the master list of map points kept by the Home Office [@Office2019]. However, analysis by [@Tompson2015] reveals that at the lower super output area (LSOA) level, 85% of areas exhibited no statistically significant difference between the masked and raw crime data. Hence, analysis of patterns in crime will predominantly be conducted at the LSOA level in this study. 

2011 census data at the LSOA level was also downloaded from the London Datastore. This is to obtain information about the total resident population in each London LSOA to calculate crime rates in each LSOA.

In addition, industrial landuse areas are obtained from OpenStreetMap using the overpass API as a polygon dataset. This is to observe if trends between the occurrence of crimes and industrial areas exist. The information from OpenStreetMap is crowd-sourced, and not created by geospatial experts. Thus, some inaccuracies may be present in the dataset [@Basiri2016]. However, corroboration of the industrial landuse polygons with aerial imagery and street imagery from Google Maps shows that the data is generally accurate, and therefore suitable for broader-scale exploratory analysis.

A point dataset of the location of entertainment outlets (defined as pubs, bars, and restaurants) in London is also obtained from OpenStreetMap. Further verification of the location of entertainment outlets also suggests that the dataset is broadly up-to-date.

```{r}
# load necessary data
load("boundaries/LondonLSOA")
load("boundaries/LondonWards")
projection <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
LondonWards <- spTransform(LondonWards, projection)
LondonLSOA <- spTransform(LondonLSOA, projection)
load("df.Rda") #crime df

# remove crime reports with no location from df
df <- df[!is.na(df$Longitude),]
df <- df[!is.na(df$Latitude),]
```

\pagebreak

# Exploratory Spatial Data Analysis
An exploratory analysis of the crime data will be conducted in this section.

A total of 1,048,712 crimes were reported in 2017. Of these crimes, 1,035,826 (98.7%) have a location. As discussed previously, only the geocoded crimes will be used in the analysis.

**Variations in Crime by Type**

The barplot below depicts the frequency of crimes by crime type in London in 2017 (Figure \@ref(fig:barplot)). Over 40% of reported crimes in London come from 2 categories - anti-social behaviour (22.0%) and violence and sexual offences (20.7%). The next two most significant crime types making up 20% of crimes are other theft (10.5%) and vehicle crime (10.0%). 36.9% of crimes fall under the remaining 10 crime types. As such, different types of crimes are reported at different frequencies, with antisocial behaviour and violence and sexual offences being the most commonly reported crimes, followed by vehicle crime and other theft.

```{r barplot, echo=FALSE, fig.cap="2017 London crime counts by crime type"}
# Plot barplot of crime type
par(mar=c(8, 4.1, 4.1, 2.1))
barplot(table(df$Crime.type),las=2, ylab="Frequency", cex.names=0.6, cex.axis=0.6, cex.lab=0.6)
text(0.7, 220000, "227995", cex = 0.6)
text(1.9,28000,"21450", cex=0.6)
text(3.1,83000,"75801", cex=0.6)
text(4.3,67000,"61446", cex=0.6)
text(5.5,38000,"32459", cex=0.6)
text(6.7,17000,"10094", cex=0.6)
text(7.9,118000,"108696", cex=0.6)
text(9.1,13000,"6603", cex=0.6)
text(10.3,55000,"47766", cex=0.6)
text(11.5,39000,"30825", cex=0.6)
text(12.7,55000,"47928", cex=0.6)
text(13.9,55000,"47422", cex=0.6)
text(15.1,110000,"103237", cex=0.6)
text(16.3,205000,"214104", cex=0.6)
```

**Variations in Crime by Type and Month**

A line graph of crime count by type and month (Figure \@ref(fig:linegraph)) is plotted to examine temporal patterns in crime in London across the year. From Figure \@ref(fig:linegraph), it is evident that the frequency of some crime types varies throughout the year. For instance, reports of anti-social behaviour appear to peak in July and August. Burglary reports appear to increase between October and January, while bicycle theft reports appear to increase between May and October).

```{r linegraph, echo=FALSE, fig.cap="2017 London crime count by type and month"}
# Plot line chart crime x month
crime_count_by_month <-data.frame(table(df$Month, df$Crime.type)) 
names(crime_count_by_month) <- c("Month", "Crime.type","Freq")

ggplot(crime_count_by_month, aes(x = Month, y = Freq, colour = Crime.type, group=Crime.type), main="Crime Count")+
  geom_line()+
  geom_point()+
  scale_color_discrete(name = "Crime types")+
  labs(y = "Crime count")
```

**Variations in Crime by LSOA**

Crime counts are also examined by LSOA, in order to study the distribution of crime in London. From Table \@ref(tab:LSOAstats), it is evident that crime counts vary significantly between LSOAs. Few LSOAs have extremely high crime counts, while 50% of LSOAs have crime counts between 64 and 211. Consequently, the jenks classification scheme will be used to map the distribution of crime counts across London, to minimise the variation within each class but highlight differences between classes. 

```{r LSOAstats}
LSOA_stats <- matrix(c(1.0, 64.0, 127.0, 175.3, 211.0, 7329.0), ncol=1, byrow=TRUE)
rownames(LSOA_stats) <- c("Minimum","1st Quartile","Median","Mean","3rd Quartile","Maximum")
colnames(LSOA_stats) <- c("Value")
LSOA_stats <- kable(LSOA_stats, caption="Crime Count Statistics by LSOA")
LSOA_stats
```

Crime count maps are plotted to visualise the spatial distribution of crime across London. The crime count map (Figure \@ref(fig:crimecountmap)) illustrates the total number of reported crimes in each LSOA in 2017. By visual inspection, crime counts are highest in central London, although some regions with higher crime counts are present along the river Thames in East London, the Lea Valley and in Hillingdon.

```{r crimecountmap, echo=FALSE, fig.cap="2017 London crime count map by LSOA"}
LondonLSOA_transformed <- LondonLSOA
# get crime count by LSOA
crimenum_by_LSOA <- data.frame(table(df$LSOA.name)) %>% na.omit()
crimenum_by_LSOA$Var1 <- as.character(crimenum_by_LSOA$Var1)
crimenum_by_LSOA <- crimenum_by_LSOA[!apply(crimenum_by_LSOA, 1, function(x) any(x=="")),] 

# get combined boundary + LSOA crime count data
LondonLSOA_transformed@data <- left_join(LondonLSOA_transformed@data, crimenum_by_LSOA, by=c("LSOA11NM"="Var1"))
LondonLSOA_transformed[is.na(LondonLSOA_transformed$Freq)]<- 0 #set Freq = 0 for LSOAs with no crimes

#plot crime count map
tmap_mode("view")
tmap_mode("plot")
tm_shape(LondonLSOA_transformed) +tm_polygons(col="Freq", palette="Blues", style = "jenks", border.col='transparent', title = "Crime counts", n=4) +tm_layout("2017 London Crime Count Map by LSOA", title.size=1)
```

A crime rate map (Figure \@ref(fig:crimeratemap)) is also plotted to take into account population size in each LSOA. This is derived by taking the crime count divided by the resident population in the corresponding LSOA and then multipled by 1000 (i.e. crime count per 1000 residents). These crime rate maps allow for the assessment of the risk of crime [@Brantingham1997]. However, it is to be noted that resident populations are used to calculate crime rate. Thus, regions with a low resident population but high pedestrian population (e.g. commercial areas) would have an inflated crime rate. 

Visually, although there are some differences between the crime rate and crime count maps, the regions with the highest crime counts are also the regions with the highest crime rates. However, a number of regions outside of central London with slightly higher crime counts (235 to 871) have lower-than-expected crime rates. This indicates that residential population does not have a significant influence on crime counts, except when crime counts are slightly elevated and occur in LSOAs outside central London (presumably with a higher residential population). 

```{r crimeratemap, echo=FALSE, fig.cap="2017 London crime rate map by LSOA"}
load("lsoa_census.Rda")
census <-  LondonLSOA_transformed
census@data <- left_join(census@data, lsoa_census, by=c("LSOA11CD" = "Codes"))
census$total_pop <- census$X0.15 + census$X16.29 + census$X30.44 + census$X45.64 + census$X65.

census$freq_pop <-  census$Freq / census$total_pop * 1000 #crime per 1000 people

tm_shape(census) + tm_polygons(col="freq_pop", palette="YlGnBu", style = "jenks", border.col='transparent', title = "Crime count per 1000 residents", n=4)+tm_layout("2017 London Crime Rate Map by LSOA", title.size=1)

# Missing data here because no residential areas in those census tracts
```
\pagebreak

# Methodology
Based on our exploratory data analysis, different crime types have different counts and spatial variations. As such, we have decided to analyse two different crime types in isolation: Violence and Sexual Offences (VSO), and Vehicle crime.

VSO is one of the most commonly reported, as well as the more severe crimes that bring about damage to people and property. Vehicle crime is chosen due to its unique nature in that it can be committed without direct contact with the victim, unlike violence and sexual offences which often requires direct contact with the victim, thus making it an interesting constrast to study. 

As the two crime types have its own spatial pattern and are likely to be caused by different factors, the methodology that we undertake will be different for each of them. 

## Methods in Analysing Violence and Sexual Offences
A spatial point pattern analysis was done on the City of London 001F (COL001F) LSOA. 

Two hypotheses were made in the process of analysing VSO crime patterns in the LSOA:

    H1. VSO crimes are randomly distributed in COL001F 

    H2. VSO crime locations positively correlate with the locations of entertainment outlets

The reason for these hypotheses will be made clearer in section 5.1. 

Here is the methodology employed to investigate the hypotheses: 

1. Test H1 with Quadrat Counting
    + If homogenous, find out if there is clustering with Ripley's K Function. 
        - If there is clustering, H1 is rejected.
        - If not, H1 is accepted.
    + If non-homogenous, use Kernel Density Estimation to identify areas with high intensity. 
        - H1 is rejected.

2. Test H2 with Inhomogenous K cross function 
    + If Inhomogenous K cross function reveals positive correlation, H2 is accepted.
    + If Inhomogenous K cross function reveals no correlation, H2 is rejected.
    + If Inhomogenous K cross function reveals negative correlation, H2 is rejected. 

The following statistical methods were used in the process:

1. Quadrat Counting
    
    To check for homogeneity is to determine whether regions of equal area contain roughly equal number of points.
    
    ![Picture 1 shows Quadrat counting for Swedish Pines data. Left: Quadrat counts. Right intensity. [@Baddeley2016]](pictures/quadratcount.png)
    
    In quadrat counting, the observation window W is divided into subregions $B_{1},...,B_{m}$ called quadrats. The numbers of points falling in each quadrat is counted. If the spatial point process is homogeneous, the intensity for each quadrat should be equal 'on average'-- the expected count in each quadrat is proportional to the area of the quadrat. Otherwise, the spatial point process is inhomogeneous. [@Baddeley2016]
    

2. Chi-sq test
    
    The Chi-sq test is used to determine whether there is a significance difference between the observed number points and the expected number of points in each quadrats, where chi-squared can be computed via:
    
    $\chi^2=\sum_{i=1}^m\frac{(k_i-\bar{\lambda})^2}{\bar{\lambda}}$
    
    If there is a significant difference, then we can reject the null hypothesis that the spatial point process is homogeneous. 
    
4. Kernel Density Estimation

    Kernel Density Estimation (KDE) estimates the probability density function of a random variable. It is used to help us visualise how the density of a point pattern varies over space. [@Haworth2018]
    
    A KDE can be written as:
    $\hat{f}(x,y)=\frac{1}{nh^2}\sum_{i=1}^nk_s(\frac{x-x_i}{h_s}\frac{y-y_i}{h_s})$
    
    where $n$ is the number of points; $x_{i}$ and $y_{i}$ are the coordinates of the point $i$, $i$ = 1,2, ... , $n$; $h_{s}$ is the bandwidth of a spatial kernel $k_{s}$.

5. Inhomogenous K cross function
    
    The inhomogenous K cross function measures whether 2 spatial point patterns are correlated, with the assumption that the spatial point patterns are inhomogenous. 
    
    $K_{ij}(r) = \frac{1}{\lambda_{j}}E[t(u,r,X^{j} | u \epsilon X^{i} )]$
    
    For any pair of types $i$ and $j$, the multitype K-function $K_{ij}(r)$, also called the bivariate or cross-type K-function, is the expected number of points of type $j$ lying within a distance $r$ of a typical point of type $i$, standardised by dividing by the intensity of points of type $j$, adjusted for spatially varying intensity. [@Baddeley2016] 
    
    
6. Monte-Carlo Simulation
    
    The monte-carlo simulation is used to generate 100 simulations of a point pattern according to a specified probability distribution, in order to test whether the result from a test is statistically significant.


## Methods in Analysing Vehicle Crime

Visual inspection of the maps suggests that vehicle crime rates appear to concentrate in regions. Thus, the following hypothesis was generated:

    H3. Vehicle crimes are spatially correlated
    
    H4. Vehicle crime rates are correlated with industrial areas
    
The reason for these hypotheses will be made clearer in section 5.2.

The Moran's I [@Moran1950] was used to test for spatial autocorrelation. It is a weighted correlation coefficient that measures if the spatial data sampled at adjacent locations are correlated with one another. It measures a single average spatial autocorrelation across the entire area. The Moran's I is calculated using the following equation:

\[I=\frac{n} {\sum_{i}\sum_{j}w_{ij}} \frac{\sum_{i}\sum_{j}w_{ij}(x_i-\bar{x})(x_j-\bar{x})} {\sum_{i}(x_i-\bar{x})^2}\]

Where \(n\) is the number of LSOAs, 
\(w_{ij}\) is the element of a spatial weight matrix \(W\) giving the spatial weight between LSOAs \(i\) and \(j\),  
\(x_i\) and \(x_j\) are the vehicle crime rates measured at LSOAs \(i\) and \(j\) respectively and \(i,j=1,2,...,n\),  
\(\bar{x}\) is the mean of \(x\) (i.e. the mean LSOA vehicle crime rate)  

A expectation of I under a null hypothesis is \(\frac{-1} {n-1}\). Values greater than that indicate a positive spatial autocorrelation, while values smaller than that indicate a negative spatial autocorrelation.  

A local Moran's I [@Anselin1995], \(I_i\),  was subsequently calculated for each LSOA, to determine the spatial autocorrelation between a given LSOA and its adjacent LSOAs. This is to observe if variations in spatial autocorrelation exist. The local Moran's I can be calculated using the following equation:

\[I_i=\frac{z_i}{m_2}\sum_{j}w_{ij}z_j\]

Where \(z_i = x_i-\bar{x}\), \(z_j = x_j-\bar{x}\), \(m_2=\frac{1}{n}\sum_{i}z_i^2\), \(\bar{x}\) is the mean vehicle crime rate, \(x\), at \(n\) LSOAs and \(i=1,2,...,n\)  

The expectation of \(I_i\) is \(\frac{-w_i}{(n-1)}\), where \(-w_i=\sum_{j}w_{ij}\). Local hotspots of positive or negative autocorrelation will be present if vehicle crime rates are spatially heterogeneous. A bonferroni adjustment was then applied to the results, to identify Moran's I values that are statistically significant at the 95% confidence interval.

The areas with high vehicle crime rates and which are statistically significant high-high clusters are then analysed using Google Map imagery. Further analysis is also conducted with industrial landuse data from OpenStreetMap.
\pagebreak


# Results and discussion

Two crime types, violence and sexual offences, and vehicle crime have been used for further analysis. Vehicle crime refers to any theft, tampering, or interference with motor vehicles [@Office2019].

As the nature of violence and sexual offences, and vehicle crime differs, examination of the spatial distribution of the two crime types in London will allow for better understanding of the factors influencing the occurrence of these two crimes.

## Analysing Violence and Sexual Offences 

```{r}
# Clean Data
vs_df <- subset(df, Crime.type == 'Violence and sexual offences')
vs_df <- vs_df[!is.na(vs_df$Longitude),]
vs_df <- vs_df[!is.na(vs_df$Latitude),]
vs_LSOA <- LondonLSOA
vs_num_by_LSOA <- data.frame(table(vs_df$LSOA.name)) %>% na.omit()
vs_num_by_LSOA$Var1 <- as.character(vs_num_by_LSOA$Var1)
vs_num_by_LSOA <- vs_num_by_LSOA[!apply(vs_num_by_LSOA, 1, function(x) any(x=="")),]
vs_LSOA@data<- left_join(vs_LSOA@data, vs_num_by_LSOA, by=c("LSOA11NM"="Var1"))
load("lsoa_census.Rda")
vs_census <-  vs_LSOA
vs_census@data <- left_join(vs_census@data, lsoa_census, by=c("LSOA11CD" = "Codes"))
vs_census$total_pop <- vs_census$X0.15 + vs_census$X16.29 + vs_census$X30.44 + vs_census$X45.64 + vs_census$X65.
vs_census$freq_pop <-  vs_census$Freq / vs_census$total_pop * 1000 #crime per 1000 people
```

By plotting the occurrence of violence and sexual offences per 1000 people on a chloropeth, we get the following map below (Figure \@ref(fig:vsocrimeratemap)):   

```{r vsocrimeratemap, echo=FALSE, fig.cap="2017 London crime rate map by LSOA"}
tm_shape(vs_census) + 
  tm_polygons(col = 'freq_pop', 
              palette = 'Greens', 
              style = 'jenks', 
              n = 3, 
              border.col = 'transparent',
              title = 'VSO crime counts per 1000 residents',
              title.position = c("right", "bottom")
              ) +
  tm_layout("2017 London VSO Crime Rate by LSOA", title.size=1)
```

This map shows us that VSO crimes are mainly concentrated in central london, with a few LSOAs having mid-range crime density dispersed across london. 

Ranking the LSOAs by crime density, we obtain the following rank table (Table \@ref(tab:top20)), showing the top 20 LSOAs with the highest crime rates (crime count per 1000 people): 
```{r top20}
top_20 <-  data.frame(vs_census@data[order(-vs_census$freq_pop)[1:20], "Names"])
#top_10_ <-  data.frame(vs_census@data[order(-vs_census$Freq)[1:20], "Names"])
top_20$freq_pop <- vs_census@data[order(-vs_census$freq_pop)[1:20], "freq_pop"]
colnames(top_20) <- c('LSOA name','Crime Rate')
kable(top_20, caption = '20 LSOAs with the highest crime rates')
```

We select the City of London 001F (COL001F) to do our analysis as it has the highest crime density. We are also interested to investigate why this is so.   

### Analysing Violence and Sexual Offences in City of London 001F
```{r clean-vso-data}
######################## Clean data ###########################
COL001F_shp <- vs_LSOA[vs_LSOA$LSOA11NM == 'City of London 001F',]
COL001F_roads <- readOGR('boundaries/COL001F_roads/COL001F_roads.shp')
COL001F_ll <- vs_df[vs_df$LSOA.name == 'City of London 001F',]
COL001F_ll <- subset(COL001F_ll, select=c("Longitude", "Latitude"))
unique_COL001F_ll <- unique(COL001F_ll)
COL001F_ll <- jitterDupCoords(COL001F_ll, max = 0.0001)
points <- SpatialPoints(COL001F_ll)
unique_points <- SpatialPoints(unique_COL001F_ll)

# set crs
wgs <- '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0'
proj4string(points) <- CRS(wgs)
proj4string(unique_points) <- CRS(wgs)
proj4string(COL001F_roads) <- CRS(wgs)

# get elements within LSOA boundary
roads <- gIntersection(COL001F_shp, COL001F_roads)
points <- gIntersection(COL001F_shp, points)
unique_points <- gIntersection(COL001F_shp, unique_points)

# manipulate data into suitable forms for buffering
for (i in 1:nrow(unique_points@coords)){
  rownames(unique_points@coords)[i] <- i
}
for (i in 1:nrow(points@coords)){
  rownames(points@coords)[i] <- i
}
```
By plotting the spatial distribution of the crimes on a map (Figure \@ref(fig:COL001Fmapwroads)), we can make our first hypothesis: 

H1. VSO crimes are randomly distributed in the City of London 001F LSOA    


```{r COL001Fmapwroads, echo=FALSE, fig.cap="City of London 001F LSOA Map with Roads"}
## plot map of COL001F
tmap_mode("plot")
# tm_shape(roads)+
#   tm_lines(col= 'grey', lwd=1.0)+ #
#   tm_layout(legend.bg.color="white",
#             title="Roads in City of London 001F",
#             title.position = c("left", "top"), fontfamily = 'Arial') +
# tm_shape(unique_points)+
#   tm_dots(size = 0.1, col = 'red', alpha = 1)
```
   
```{r COL001F-ppp}
### Get ppp object
points_ll <-  data.frame(points@coords)
coordinates(points_ll) <- ~x+y
pts <- coordinates(points_ll)
COL001F_Owin <- as.owin(COL001F_shp)
COL001F_ppp <- ppp(pts[,1],pts[,2], window=COL001F_Owin)
```
To test for H1, we employ the use of quadrat counting. If the spatial pattern is homogeneous, each quadrat should have roughly the same amount of intensity (points per area) (Figure \@ref(fig:COL001Fhomo)).      
```{r COL001Fhomo, echo=FALSE, fig.cap="Quadrat counts within COL001F LSOA"}
### test for homogeneity 
qX <- quadratcount(COL001F_ppp, nx = 8 , ny = 4)
plot(COL001F_ppp, pch=16)
plot(qX, add = TRUE, lty=2, cex = 0, col = 'red') 
```
  
A chi-sq test  gives the following results:   
```{r COL001F-homo-chisq}
qt <- quadrat.test(COL001F_ppp, nx = 8, ny = 4)
qt
```
  
As the p-value is less than 0.05, it rejects the null hypothesis that the crimes are homogeneous.   

Next, we use the Kernel Density Estimation to visualise the different intensities of the VSO crime on the map.      
```{r COL001F-KDE}
COL001F_den <- density(COL001F_ppp)
plot(COL001F_den, main='City of London 001F')
```

From the map, clusters of VSO crime seem to occur North-East of City of London 001F. To understand why this is so, we can study the area in more detail (red box).    

![](pictures/COL001F_Hotspot_box.png)  

The street level view reveals a hotspot of 67 VSO crimes in the region. 

![](pictures/COL001F_Hotspot.png)

Based on visual inspection alone, the offences seem to congregate around public entertainment outlets (orange markers above). Here, we construct a second hypothesis.   

H2: The location of VSO crimes correlate with the location of entertainment outlets.      

We define entertainment outlets here to be: restaurants, bars and pubs. With open street map, we can extract the locations of these outlets and visualise them on a map, alongside the VSO crimes:   

```{r COL001F-redbluedotmap}
# get COL001F osm data
COL001F_nodes_ways <- readRDS(file = "COL001F_nodes_ways.rds")

# create POIs
POIs_df <- data.frame()
POIs_category <- c('restaurant','pub', 'bar')
for (i in 1:length(POIs_category)){
  id <- find(COL001F_nodes_ways, node(tags(v == POIs_category[i])))
  poi <- subset(COL001F_nodes_ways, id)
  poi <- as_sp(poi, "points")
  poi <- spTransform(poi, wgs)
  poi <- gIntersection(poi, COL001F_shp)
  POIs_df <- rbind(POIs_df,poi@coords)
}
colnames(POIs_df) <- c('Longitude','Latitude')
POIs <-  SpatialPoints(POIs_df)
proj4string(POIs) <- wgs

# plot POIs against VSO crime locations

tm_shape(COL001F_shp)+
  tm_polygons(col= 'white', lwd=1.0)+ 
tm_shape(points)+
  tm_dots(size = 0.1, col = 'red', alpha = 1, title = 'VSO')+
tm_shape(POIs)+
  tm_dots(size = 0.1, col = 'blue', alpha = 1, title = 'Entertainment outlets')+
  tm_layout(
    title="VSO Crime & Entertainment Outlet Locations in London 001F",
    title.position = c("left", "top"),
    title.size = 0.8 ) +
tm_add_legend(
  type = c("fill"),
  labels = c('VSO crimes','Entertainment Outlets'),
  col = c('red','blue'))
```
  
Visually, the map seems to agree with our hypothesis. VSO crime locations seem to correlate with locations of entertainment outlets. We can perform an inhomogeneous kcross function to determine their spatial relationship.   

```{r COL001F-kcross}
##### prepare data for kcross #####
# create joint pubs_points df
POIs_type <- rep('POIs', nrow(POIs@coords))
points_type <- rep('crime', nrow(points@coords))
POIs_df <- data.frame(lat = POIs$Latitude, lng = POIs$Longitude ,type = POIs_type)
points_df <- data.frame(lat = points$y, lng = points$x ,type = points_type)
POIs_points <- rbind(POIs_df, points_df)

# create ppp object for joint pubs_points df
coordinates(POIs_points) <- ~lng+lat
pts <- coordinates(POIs_points)
POIspoints_ppp <- ppp(pts[,1],pts[,2], window=COL001F_Owin, marks = POIs_points$type)

# kcross test
kc <- Kcross.inhom(POIspoints_ppp, i ='POIs', j = 'crime')
plot(kc)
```
  
The inhomogeneous kcross function tells us that there is in fact, a repulsive spatial relationship between the location of VSO crimes and the location of entertainment outlets (lines below the blue line) -- VSO crimes do not cluster around entertainment outlets.  

Running a monte-carlo simulation tells us whether this observation is statistically significant:  

```{r COL001F-kcross-monte}
Kcross.inhom_monte_carlo <- envelope(POIspoints_ppp, fun = Kcross.inhom, nsim =100, i = 'POIs', j = 'crime')
plot(Kcross.inhom_monte_carlo)
```

The observed *Kcrossinhom* line lies below and outside of the acceptance region. This means that the null hypothesis that the 2 variables are independent is rejected. The results also indicate a dispersive relationship between the 2 variables.   

This finding is surprising because we expected the 2 variables to be attractive. We may be able to explain this finding though, that the inhomogeneous Kcross function accounted for the the inhomogeneity in the spatial point pattern, brought about by private buildings and parks (random empty spaces on the map).   

So although the 2 variables seem to be occurring in the 'same place', they are in fact brought together because of the spatial structure of the environment. The presence of parks and buildings 'forces' the points to go along in a particular direction. This means if we plot other variables on the map as well (for example: other crimes or locations of supermarkets, etc.), their spatial locations may appear similar too -- avoiding the spaces that can't be occupied (parks, private spaces and buildings) and occupying the spaces that can be.     
Just out of curiosity, we can do simple tabulation of the number of VSO crimes that happen on the streets. 

```{r COL001F-roads-intersect, results = 'asis'}
### Clean data for buffer to work ####
tmerc <- "+proj=tmerc +lat_0=42.5 +lon_0=-72.5 +k=0.9999642857142857 +x_0=500000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
points <- spTransform(points, CRS(tmerc))
roads <- spTransform(roads, CRS(tmerc))

buffered_points <- gBuffer(points, width = 5, byid=TRUE)

points_on_roads <- gIntersects(roads,buffered_points, byid=TRUE)
kable(table(points_on_roads), caption = 'Points on the streets')
```

The results show that **`r round(table(points_on_roads)['TRUE']/sum(table(points_on_roads))*100)`%** of VSO crimes happen on the streets. This may support our hypothesis that the spatial pattern of the VSO crimes is heavily influenced by the spatial structure of the environment. 

The repulsive relationship between VSO crimes and entertainment outlets (bars, pubs and restaurants) is still surprising though and we are uncertain why this is so. Perhaps these are places people usually go to with a group of friends of family and hence it is more difficult for perpatrators to commit VSOs? These are also places with high visibility therefore perpatrators do not dare to commit VSOs? VSOs at bars and pubs are also likely to go unreported, because of the nature of their environments? Or perhaps it could be because of a related variable that causes this repulsive relationship? Clearly, more analysis and research is needed in this area. 

```{r H031A-map}

#### Just Hillingdon 031A #### 
H031A_shp <- vs_LSOA[vs_LSOA$LSOA11NM == 'Hillingdon 031A',] 
H031A_ll <- vs_df[vs_df$LSOA.name == 'Hillingdon 031A',] 
H031A_ll <- subset(H031A_ll, select=c("Longitude", "Latitude"))

H031A_map <- leaflet(H031A_ll) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(radius = 1, color = 'blue') %>%  
  addPolygons(data = H031A_shp, weight = 1) 

H031A_map 
  
```

## Analysing Vehicle Crime

```{r}
# get only vehicle crime
dfvehicle <- df[(df$Crime.type=="Vehicle crime"),]
dfvehicle <- dfvehicle[!is.na(dfvehicle$Longitude),]
dfvehicle <- dfvehicle[!is.na(dfvehicle$Latitude),]
```

Figure \@ref(fig:vhcrimeratemap) shows the spatial distribution of vehicle crime rates by LSOA. Several generalised observations are described below:  
1. Majority of LSOAs with the highest crime rates are located north of the river Thames  
2. LSOAs with the highest crime rates tend to be found along the river Thames   
3. LSOAs in (2) can be grouped into 4 main areas: East London (e.g. Newham, Barking, Greenwich), Central London (e.g. City of London, Westminster), Southwest London (e.g. Kensington, Knightsbridge), West London (e.g. Heathrow, Acton, Hammersmith, Chiswick)  

```{r}
# get vehicle count by LSOA
vehiclenum_by_LSOA <- data.frame(table(dfvehicle$LSOA.name)) %>% na.omit()
vehiclenum_by_LSOA$Var1 <- as.character(vehiclenum_by_LSOA$Var1)
vehiclenum_by_LSOA <- vehiclenum_by_LSOA[!apply(vehiclenum_by_LSOA, 1, function(x) any(x=="")),]

# transform to leaflet's CRS
LondonWards_transformed_vehicle <- spTransform(LondonWards, projection)
LondonLSOA_transformed_vehicle <- spTransform(LondonLSOA, projection)

# get combined boundary + LSOA vehicle count data
LondonLSOA_transformed_vehicle@data <- left_join(LondonLSOA_transformed_vehicle@data, vehiclenum_by_LSOA, by=c("LSOA11NM"="Var1"))
LondonLSOA_transformed_vehicle[is.na(LondonLSOA_transformed_vehicle$Freq)]<- 0 #set Freq = 0 for LSOAs with no crimes
```

```{r vhcrimeratemap, echo=FALSE, fig.cap="2017 London vehicle crime rate map by LSOA"}
load("lsoa_census.Rda")
vehicle_census <-  LondonLSOA_transformed_vehicle
vehicle_census@data <- left_join(vehicle_census@data, lsoa_census, by=c("LSOA11CD" = "Codes"))
vehicle_census$total_pop <- vehicle_census$X0.15 + vehicle_census$X16.29 + vehicle_census$X30.44 + vehicle_census$X45.64 + vehicle_census$X65.
vehicle_census[is.na(vehicle_census$Freq)]<- 0 #set Freq = 0 for LSOAs with no crimes

vehicle_census$freq_pop <-  vehicle_census$Freq / vehicle_census$total_pop * 1000 #crime per 1000 people

tmap_mode("plot")
#tmap_mode("view")
tm_shape(vehicle_census)+ tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents")+tm_layout("2017 London Vehicle Crime Rate by LSOA", title.size=0.8)

# Missing data here because no residential areas in those census tracts??
```

### Spatial autocorrelation of vehicle crime

Earlier observations suggests that LSOAs with high vehicle crime rates occur in regions. Thus, this section will investigate this further, by examining spatial autocorrelation of vehicle crime at the LSOA level based on regions with contiguous boundaries. 
```{r, echo=FALSE}
#Global Moran's I
vehicle_LSOA <- vehicle_census
nb <- poly2nb(vehicle_LSOA) #function that builds a neighbours list based on regions with contiguous boundaries

Wl <- nb2listw(nb) # a listw object is a weights list for use in autocorrelation measures
#moran(vehicle_LSOA$Freq, Wl, n=length(Wl$neighbours), S0=Szero(Wl))
#Moran's I calculated here is 0.360, suggesting positive autocorrelation

#Test statistical significance of I value using statistical test based on randomisation
#moran.test(vehicle_LSOA$Freq, Wl)

#Test statistical significance using permutation test, specifically using Monte-Carlo simulation (using 999 permutations)
#moran.mc(vehicle_LSOA$Freq, Wl, nsim=999)

#At the LSOA level, frequency of vehicle crimes display significant, positive autocorrelation in London.
```

A global Moran's I calculation was ran for all the London LSOAs. The resultant I value of 0.36013 suggests that a positive autocorrelation in vehicle crime counts exist on average across the entire area. Results for the Moran's I test using randomisation and the Monte-Carlo simulation using 999 simulations both produce small p-values of 2.2e-16 and 0.001 respectively, suggesting that the calculated Moran's I value is highly statistically significant. Thus, at the LSOA level, frequency of vehicle crimes display, on average, a significant positive autocorrelation in London.

**Local spatial autocorrelation**

Local variations in spatial autocorrelation are also examined, to determine if levels of autocorrelation vary due to spatial heterogeneity. This is done by calculating local Moran's I values for each LSOA.

LSOAs with local Moran's I values that are statistically significant at the 95% confidence interval were then mapped. Figure \@ref(fig:vhmorancluster) shows that spatial autocorrelation is non-significant across most of London. It is however noteworthy that the LSOAs with the highest crime rates also tend to form statistically significant high-high clusters. Specifically, high-high clusters are present in West London, central London and East London along the river Thames. This confirms the earlier hypothesis that there is a concentration of crimes on a local level in different regions of London. It is also notable that several other LSOAs (that do not have relatively high vehicle crime rates) also have high-high clusters, indicating that spatial autocorrelation is not only restricted to regions with high vehicle crime rates. This may be related to characteristics of the region or criminal behaviour. Interestingly, a single low-low cluster is observed in South London, in the Bexley region.

```{r vhmorancluster, echo=FALSE, fig.cap="LSOAs with statistically significant local Moran's clusters for vehicle crime"}
# adjust local Moran's I to show HH and LL clusters
moranCluster <- function(shape, W, var, alpha=0.05, p.adjust.method="bonferroni")
{
  # Code adapted from https://rpubs.com/Hailstone/346625
  Ii <- localmoran(shape[[var]], W, p.adjust.method=p.adjust.method)
  shape$Ii <- Ii[,"Ii"]
  shape$Iip <- Ii[,"Pr(z > 0)"]
  shape$sig <- shape$Iip<alpha
  # Scale the data to obtain low and high values
  shape$scaled <- scale(shape[[var]]) # high low values at location i
  shape$lag_scaled <- lag.listw(Wl, shape$scaled) # high low values at neighbours j
  shape$lag_cat <- factor(ifelse(shape$scaled>0 & shape$lag_scaled>0, "High-high",
                                 ifelse(shape$scaled>0 & shape$lag_scaled<0, "High-low",
                                        ifelse(shape$scaled<0 & shape$lag_scaled<0, "Low-low",
                                               ifelse(shape$scaled<0 & shape$lag_scaled<0, "Low-high", "Equivalent")))))
  shape$sig_cluster <- as.character(shape$lag_cat)
  shape$sig_cluster[!shape$sig] <- "Non-sig"
  shape$sig_cluster <- as.factor(shape$sig_cluster)
  results <- data.frame(Ii=shape$Ii, pvalue=shape$Iip, type=shape$lag_cat, sig=shape$sig_cluster)

  return(list(results=results))
}

clusters <- moranCluster(vehicle_LSOA, W=Wl, var="Freq")$results
vehicle_LSOA$Ii_cluster <- clusters$sig

#plot Ii values by HH, LL and non-sig
tmap_mode("plot")
tm_shape(vehicle_LSOA) + tm_polygons(col="Ii_cluster", border.col='transparent', title = "Nature of cluster")
```

These high-high clusters can be used to identify buffer regions with high vehicle crime rates - a high-high clusters are only identified when an LSOA with high crime rates is surrounded by LSOAs with high crime rates. This can aid the allocation of police resources and outreach efforts in the event of a resource shortage. It is also a strategic move, as the spatial autocorrelation in vehicle crimes may mean that a reduction of crime in one LSOA has effects on crime rates in neighbouring LSOAs.

### Reasons for vehicle crime rates

Earlier analysis reveals that elevated crime rates tend to occur in specific regions, and there is spatial autocorrelation at the LSOA level. Therefore, this section will examine regions with high vehicle crime rates to identify variables that may contribute to high crime rates.

**East London**

In East London, the LSOAs with high crime rates either have 1) industrial parks/scrapyards/depots (e.g. Barking LSOAs, Newham LSOAs) and/or 2) retail parks/leisure parks (e.g. Newham LSOAs, Greenwich LSOAs). For instance, the agglomeration of retail parks in Newham (and the accompanying parking lots), such as the Gallions Reach shopping park, Beckton Triangle retail park and Gateway retail park may contribute to the elevated vehicle crime rates in the LSOA. Likewise, in Greenwich, the presence of leisure parks and the O2 stadium may contribute to the high vehicle crime rates. The high vehicle crime rates at retail parks/leisure parks suggests that thieves are likely opportunistic, and target these areas due to the high volume of vehicles parked in these areas.

![Parking lots at retail parks at Newham](pictures/Newhamshopping.png)

On the other hand, in parts of Barking, the high vehicle crime rates may be attributed to industrial parks and scrapyards. The high rates of vehicle crime at industrial areas is interesting, as the vehicles are often old and/or damaged. This suggests that thieves may steal vehicle parts from these areas. Industrial areas are also relatively quiet and empty at night, which may mean that the risk of getting caught is lower. The perceived risk may be a contributory factor to the higher crime rates.

![Vehicles at industrial area in Barking](pictures/Barkingscrapyard.png) 

**West London**

Interestingly, crime patterns are different in West London and can generally be linked to either carparks or car dealers. High rates of vehicle crime near Heathrow airport may be attributed to the high volumes of parked vehicles at short-stay and long-stay carparks. Criminals may therefore choose to operate near the airport, particularly at the long-stay carparks which are likely used by individuals travelling abroad. 

![Locations of carparks around Heathrow airport](pictures/heathrowcarpark.png)

The high crime rates in Chiswick may also be linked to the presence of large numbers of parked cars, as the LSOAs with the highest crime rates tend to have either carparks associated with supermarkets or car dealers. These observations are consistent with the hypothesis that thieves are opportunistic, and pick areas with more parked vehicles. 

![Agglomeration of car dealers in Chiswick](pictures/chiswickcardealers.png)

However, these hypotheses do not apply to Hammersmith and parts of Hounslow, both of which appear to be predominantly residential. It may be possible that these LSOAs have high crime rates as they are in the vicinity of other hotspots, such as those in Chiswick.

Vehicle crime rates are also high in Richmond, and may be linked to the presence of multiple carparks and the affluent demographic of the area.

**Southwest London**

In contrast to other regions, where high crime rates are associated with industrial and commercial areas, in Southwest London, high vehicle crime rates occur in residential areas such as Kensington, Chelsea and Knightsbridge. Unlike other areas, the volume of parked vehicles is not exceptionally high - there are no carparks/industrial areas/car dealers. However, there are numerous luxury vehicles parked in these areas, as they are affluent neighbourhoods. Hence, it is likely that vehicle crime rates are high in these region, as thieves operating in these areas specifically target high-value vehicles.

![Luxury vehicles in Knightsbridge](pictures/Knightsbridge.png)

**Central London** 

It is not clear why vehicle crime rates are high in central London, particularly in the City of London and Westminster. However, it is also interesting that some parts of the City of London (e.g. Moorgate, Barbican) have low vehicle crime rates - this may be due to the presence of secure parking in underground carparks.


### Discussion 

More detailed examination of regions with high vehicle crime rates suggests two main modes of operation for criminals:  
1) Operating in areas with large numbers of parked vehicles (i.e. quantity over quality)  
2) Operating specifically in affluent areas to target high-value vehicles (i.e. quality over quantity)

Based on hypothesis (1), further analysis has identified industrial areas and large carparks to be significant variables associated with elevated vehicle crime rates. A map of industrial areas and the vehicle crime rates by LSOAs is therefore generated to visualise the relationship between vehicle crime rates and industrial areas (Figure \@ref(fig:industrialmap)). There appears to be a correlation between industrial areas and vehicle crime rates. This may be because these areas tend to be quiet at night thus, the risk of getting caught is lower. Future work to model vehicle crime patterns can therefore consider including distance from industrial areas or the proportion of land allocated to industrial uses in each LSOA as variables to be modelled. Distances to the nearest police station can also be considered as a proxy for perceived risk of getting caught.

Ideally, the relationship between large carparks (as a proxy for the number of parked vehicles) and vehicle crime rates will also be visualised. However, datasets for carparks are not fully complete - for instance, the data on OpenStreetMap mainly limited to central London. Moreover, the dataset provides information on general parking spaces (which could be anywhere), and not the location of large carparks. Future work can consider examining the relationship between large car parks and vehicle crime rates.

Based on hypothesis (2), future work can consider incorporating income data in residential areas as a variable contributing to vehicle crime rates.

That said, high crime rates in central London and other residential (but not particularly affluent) parts of West London such as Hammersmith cannot be explained using the above hypotheses. Further studies can look towards understanding criminal behaviour in these regions.

Lastly, analysis of the vehicle crime dataset is conducted in the form of areal analysis at the LSOAs level. Different levels of analysis may produce different results, and a higher level of aggregation (e.g. at the borough level) may produce different trends. Whilst the observations at the broader areal level between LSOAs suggests that a relationship between industrial areas, car parks with vehicle crime, as well as a relationship between affluent areas and high-value vehicle crime exists, more detailed point analyses at a local level may suggest otherwise. Thus, further work can be conducted within LSOAs, to examine the interactions between these variables at a local level.

```{r industrialmap, echo=FALSE, fig.cap="Location of carparks and industrial areas on top of vehicle crime rates"}
# industrialosm <- opq(bbox = 'greater london uk') %>%
#     add_osm_feature(key = 'landuse', value = 'industrial') %>%
#     osmdata_xml(filename = 'industrial.osm')
# 
# dat <- sf::st_read('industrial.osm', layer = 'multipolygons', quiet = TRUE)
# 
# dat_sp <- as(dat, 'Spatial')
# dat_sp_transformed <- spTransform(dat_sp, projection)
# 
# dat_dropped <- gIntersection(dat_sp_transformed, LondonLSOA_transformed_vehicle, byid=FALSE, id=NULL,
#  drop_lower_td=FALSE, unaryUnion_if_byid_false=TRUE, checkValidity=FALSE)

#save(dat_dropped, file="dat_dropped.Rda")
load("dat_dropped.Rda")

#tmap_mode("view")
#tm_shape(vehicle_census)+ tm_layout("Industrial estates and vehicle crime rates by LSOA") + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents", alpha=0.4)+tm_shape(dat_dropped)+tm_polygons(col='black', border.col='transparent',alpha=0.4)

tmap_mode("plot")
tm_shape(vehicle_census)+ tm_layout("Industrial estates and vehicle crime rates by LSOA", title.size = 2) + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents")+tm_shape(dat_dropped)+tm_polygons(col='black', border.col='transparent',alpha=0.6)
```

\pagebreak

# Overall discussion and conclusions

compare between crime type
Different crime type -- different patterns  (so employ different method)

comparing between analysing local scale vs LSOA level
- prove that results obtained by analysing a single LSOA cannot be generalised to other LSOA
- hence shows the limitations of a local scale analysis --- that can only be achieved in a LSOA-level analysis 
- Insert heathrow VSO map -- show that theres no pubs etc. -- show that spatial structure of the environment is vastly different

Future work


Spatial point pattern vs Areal analysis 

In conclusion, visual analysis of the location of entertainment outlets and VSO crimes suggest that they are positively correlated. However, further statistical analysis indicates that a repulsive relationship exists between the two. This scenario underpins the importance of rigorous statistical analysis in testing observations. The reasons for the repulsive relationship are unknown, and further research can be conducted in this area. This can include the incorporation of pedestrian footfall data.

Areal analysis of vehicle crime rates at the LSOAs level indicates cluters of high vehicle crime in parts of West London, East London, Central London and Southwest London. Several hypotheses for these cluster have been formulated. Specifically, these clusters may be attributed to 1) large numbers of parked vehicles, or 2) a concentration of high-end vehicles. Future work can looking into quantifying the effect of variables such as the distance from industrial areas, carparks, and the nearest police station. 

Analysis at the LSOA level is subject to the modifiable areal unit problem, and further investigation of the individual points can be considered to better understand the dynamics at the local level. The limitations of a localised point-based analysis can thus be partially addressed using a broader areal-level analysis, and vice versa. 

As such, an integrated approach will be the best approach.

\pagebreak

# References



<!-- ### Analysing Factors that Contribute to VSO -->
<!-- ```{r} -->
<!-- ### Clean census data -->
<!-- #https://data.london.gov.uk/dataset/lsoa-atlas -->
<!-- # lsoa_census <- read.csv('data/lsoa_data_edited.csv') -->
<!-- # lsoa_census$house_price <- as.numeric(lsoa_census$house_price) -->
<!-- # lsoa_census_2 <- read.csv('data/lsoa_data_edited_2.csv') -->
<!-- # lsoa_census <- left_join(lsoa_census, lsoa_census_2, by=c("Codes"="Codes", -->
<!-- #                                                           "Names" = "Names")) -->
<!-- # save(lsoa_census,file="lsoa_census.Rda") -->
<!-- load("lsoa_census.Rda") -->
<!-- vs_census <-  vs_LSOA -->
<!-- vs_census@data <- left_join(vs_census@data, lsoa_census, by=c("LSOA11CD" = "Codes")) -->
<!-- vs_census.W <- nb2listw(poly2nb(vs_census)) -->

<!-- # run durbin model -->
<!-- vs.durbin <- lagsarlm(Freq ~ X0.15 + X16.29 + X30.44 + X45.64 + X65. + Working.age + person_per_hectare + couple_w_children + white + uk_born + household_no_english + Christian + Buddhist + Hindu + Jewish + Muslim + Sikh + other_religion + no_religion + owned_outright + social_rented + private_rented + household_at_least_one_usual_resident + household_no_usual_resident + whole_house + apartment + house_price + unemployment_rate + bad_health + no_cars_in_household + poor_transport_access + household_income, data = vs_census@data, listw = vs_census.W, type = 'mixed') -->

<!-- summary(vs.durbin) -->
<!-- ``` -->
<!-- **Here are the results** -->
<!-- Significant and negatively correlated:   -->
<!-- X0.15, X16.29, X45.64, X65, person_per_hectare, owned_outright, household_at_least_one_usual_resident, apartment, poor_transport_access                     -->

<!-- Significant and positively correlated:   -->
<!-- Christian, Buddhist, Hindu, Jewish, Muslim, no_religion, private-rented, household_no_usual_resident, unemployment_rate , no_cars_in_household , household_income                                          -->
<!-- ### Extra code below  -->

<!-- res_net <- google_places(location = c(51.513841,-0.088650), -->
<!--               place_type = "restaurant", -->
<!--               radius = 20000, -->
<!--               key = api_key) -->
<!-- #### Get COL001F roads shapefile #### -->
<!-- # library('osmar') -->
<!-- # library('geosphere') -->
<!-- # london.box <- center_bbox(center_lon = -0.090074, center_lat = 51.515190, width =  1900, height = 1900) -->
<!-- # api <- osmsource_api(url = "https://api.openstreetmap.org/api/0.6/") -->
<!-- # london <- get_osm(london.box, source = api) -->
<!-- # ways <- find(london, way(tags(k == "highway"))) -->
<!-- # ways <- find_down(london, way(ways)) -->
<!-- # ways <- subset(london, ids = ways) -->
<!-- # hw_lines <- as_sp(ways, "lines")   -->
<!-- # raster::shapefile(hw_lines,'COL001F_roads.shp') -->
<!-- # spplot(hw_lines, zcol = "uid") -->
<!-- # mapview(hw_lines)  -->

<!-- Plotting VSO by LSOA, we get the following map:   -->
<!-- ```{r} -->
<!-- # Plot map -->
<!-- cc_colors <- c('#FFE80C','#FF7700','#E81501') -->
<!-- cc_pal <- colorBin( -->
<!--   palette = cc_colors, -->
<!--   bins = c(0,10,100,2000), -->
<!--   na.color='black') -->

<!-- pop_up_text = paste("Region: ", vs_LSOA$LSOA11NM, "<br>", -->
<!--                           "Value: ", vs_LSOA$Freq, "<br>") -->

<!-- vs_LSOA_map <- leaflet(vs_LSOA) %>% -->
<!--   addProviderTiles(providers$CartoDB.Positron) %>% -->
<!--   setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>% -->
<!--   addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1, -->
<!--     color = ~cc_pal(Freq), popup = pop_up_text) %>%  -->
<!--   addLegend("bottomright",  -->
<!--     colors= cc_colors,  -->
<!--     labels=c('0-10', "10-100","100-2000"), -->
<!--     opacity= 1) -->

<!-- vs_LSOA_map -->
<!-- ``` -->


<!-- ### Violence and Sexual Offences   -->
<!-- Violence and sexual offences (VSO) crime is chosen as it is one of the more severe crimes that bring about damage to people and property. Violence includes murder, kidnap, etc hence the level of severity of this nature of crime can be high. We want to understand more about these types of crimes in order to help understand and possibly predict the factors that contribute to this crime type.    -->

<!-- ```{r} -->
<!-- # Get violence and sexual offences crimes only -->
<!-- vs_df <- subset(df, Crime.type == 'Violence and sexual offences') -->
<!-- vs_df <- vs_df[!is.na(vs_df$Longitude),] -->
<!-- vs_df <- vs_df[!is.na(vs_df$Latitude),] -->
<!-- ``` -->

<!-- If we plot a year's worth of VSO on a map, we would get the following result:    -->
<!-- ```{r} -->
<!-- # Violence and Sexual Offences Map  -->
<!-- vs_dot_map <- leaflet(vs_df) %>%  -->
<!--     addProviderTiles(providers$CartoDB.Positron) %>% -->
<!--   setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>% -->
<!--   addCircleMarkers(radius =1, color = 'red', stroke = FALSE, fillOpacity = 0.5) -->

<!-- vs_dot_map -->

<!-- ``` -->
<!-- This map is not very helpful in telling us much information about the crime nature. Hence, we employ some methods in point pattern analysis to help us understand more.  -->

<!-- ### Point Pattern Analysis -->
<!-- ```{r} -->
<!-- # get ppp file -->
<!-- london_shape <- readOGR('boundaries/greaterlondon.geojson') -->
<!-- vs_spatial_points <-  vs_df -->
<!-- coordinates(vs_spatial_points) <- ~Longitude+Latitude -->
<!-- pts <- coordinates(vs_spatial_points) -->
<!-- londonOwin <- as.owin(london_shape) -->
<!-- vs_ppp <- ppp(pts[,1],pts[,2], window=londonOwin) -->

<!-- # ggplot(data=vs_LSOA@data, aes(vs_LSOA$Freq)) + geom_histogram() + ggtitle('Violence and Sexual Assault Crimes in 2017') + ylab('Number of LSOAs') + xlab('Violence and Sexual Offences Occurrence') -->
<!-- ``` -->

<!-- Looking at the density plot below, we see that VSO is the most dense in the central part of London. -->
<!-- ```{r} -->
<!-- # density plot -->
<!-- ds <- density(vs_ppp) -->
<!-- plot(ds, main='Violence and Sexual Offences') -->
<!-- ``` -->

<!-- To test for spatial clustering, we run ripley's K function and it indicates that there is a high level of clustering for VSO.  -->
<!-- ```{r} -->
<!-- # ripley's k function -->
<!-- ktest <- Kest(vs_ppp) -->
<!-- plot(ktest) -->
<!-- ``` -->

<!-- However, this result is not very helpful. The sheer number of cases in central london as compared to everywhere else, skews ripley's K function -- there is clustering and the clustering happens in central london.    -->

<!-- We could perhaps analyse VSO by LSOAs to ensure that the crime density is contained.  -->



<!-- ### Map pubs in london -->
<!-- ```{r} -->
<!-- library("raster") -->
<!-- library("sp") -->
<!-- pubs <- readOGR("data/pubs.geojson", "OGRGeoJSON",require_geomType="wkbPoint") -->
<!-- pubs <- spTransform(pubs, CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")) -->

<!-- plot(LondonLSOA) -->
<!-- plot(pubs, col="red" , add=TRUE) -->
<!-- l <- LondonLSOA -->
<!-- l@data <- subset(l@data,select=c('LSOA11NM')) -->
<!-- res <- sp::over(pubs, l) -->

<!-- res <- poly.counts(pubs,LondonLSOA) -->
<!-- setNames(res, LondonLSOA@data$lala) -->

<!-- pubs <- readOGR("data/pubs.geojson", "OGRGeoJSON",require_geomType="wkbPoint") -->
<!-- map <- leaflet() %>% -->
<!--   addProviderTiles(providers$CartoDB.Positron, group = "Base") %>% -->
<!--   addCircleMarkers( -->
<!--     data = pubs, -->
<!--     radius = 1, -->
<!--     color = "red", -->
<!--     stroke = TRUE, fillOpacity = 1) -->

<!-- map -->
<!-- ``` -->
<!-- ![](outputs/GIFs/all_gifs/Anti-social behaviour.gif) -->

<!-- ### Create Maps for GIF -->
<!-- ```{r} -->
<!-- months <- c("2017-01","2017-02","2017-03","2017-04","2017-05","2017-06","2017-07","2017-08","2017-09","2017-10","2017-11","2017-12") -->

<!-- crime_types <- unique(df$Crime.type) -->

<!-- for (crime_type in crime_types){ -->
<!--   for (month in months){ -->
<!--   single_crime_df <- subset(df, Crime.type == crime_type & Month == month) -->
<!--   single_crime_map <- leaflet(single_crime_df, width = "100%")%>% -->
<!--   addProviderTiles(providers$CartoDB.Positron) %>% -->
<!--   setView(lng = -0.118092, lat = 51.509865, zoom = 9)%>% -->
<!--   addCircleMarkers(radius =1, color = 'red', stroke = FALSE, fillOpacity = 0.5) %>% -->
<!--   addLabelOnlyMarkers(lng = -0.5, lat = 51.7, label = month, -->
<!--                       labelOptions = labelOptions(noHide = T, textOnly = T,style = list( -->
<!--         "color" = "black", -->
<!--         "font-family" = "source sans pro", -->
<!--         "font-style" = "bold", -->
<!--         "font-size" = "20px", -->
<!--         "border-color" = "rgba(0,0,0,0.5)" -->
<!--       ))) -->
<!--   path <- sprintf("/GIFs/%s/%s_%s.png", crime_type, crime_type,month) -->
<!--   print(path) -->
<!--   mapshot(single_crime_map, file = paste0(getwd(), path, sep="")) -->
<!-- } -->
<!-- } -->

<!-- ``` -->

<!-- ### Create GIFs -->
<!-- ```{r} -->

<!-- library(purrr) -->
<!-- library(magick) -->

<!-- crime_types <- unique(df$Crime.type) -->

<!-- for (crime_type in crime_types){ -->
<!--   file_path = paste0(getwd(), sprintf("/GIFs/%s", crime_type), sep="") -->
<!--   list.files(path = file_path, pattern = "*.png", full.names = T) %>% -->
<!--     map(image_read) %>% # reads each path file -->
<!--     image_join() %>% # joins image -->
<!--     image_animate(fps=2) %>% # animates, can opt for number of loops -->
<!--     image_write(sprintf("%s.gif",crime_type)) # write to current dir -->
<!-- } -->

<!-- ``` -->


<!-- ### Clean Data -->
<!-- ```{r} -->
<!-- # Load crime and boundary data -->
<!-- COL_data <- read.csv(file=paste(getwd(),'/data/COL_street.csv',sep=''), header=TRUE, sep="\t") -->
<!-- metro_data <- read.csv(file=paste(getwd(),'/data/metro_street.csv',sep=''), header=TRUE, sep="\t") -->
<!-- data <- rbind(COL_data, metro_data) -->
<!-- load("boundaries/LondonLSOA") -->
<!-- load("boundaries/LondonWards") -->
<!-- projection <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") -->
<!-- LondonWards <- spTransform(LondonWards, projection) -->
<!-- LondonLSOA <- spTransform(LondonLSOA, projection) -->

<!-- # get crime df -->
<!-- df <- subset(data, select=c("Crime.type", "LSOA.name","Longitude","Latitude","Month")) -->
<!-- save(df,file="df.Rda") -->
<!-- ``` -->



<!-- safa -->
<!-- ```{r} -->
<!-- #Local Moran's I -->

<!-- #calculate unadjusted local Moran's I using localmoran -->
<!-- Ii <- localmoran(vehicle_LSOA$Freq, Wl) -->
<!-- #Note: localmoran returns p-value with Bonferroni adjustment -->
<!-- vehicle_LSOA$Ii <- Ii[,"Ii"] #store Ii in a column in medianhpward -->
<!-- tm_shape(vehicle_LSOA) + tm_polygons(col="Ii", palette="-RdBu", style="quantile", border.col="transparent") -->

<!-- #ADJUSTED P-VALUE -->
<!-- #calculate adjusted local Moran's I -->
<!-- Ii_adjusted <- localmoran(vehicle_LSOA$Freq, Wl, p.adjust.method = "bonferroni") -->
<!-- vehicle_LSOA$Iip_adjusted <- Ii_adjusted[,"Pr(z > 0)"] -->
<!-- #make all Ii values nonsignificant -->
<!-- vehicle_LSOA$Ii_ad_sig <- "nonsignificant" -->

<!-- #then make significant Ii values significant -->
<!-- vehicle_LSOA$Ii_ad_sig[which(vehicle_LSOA$Iip_adjusted < 0.05)] <- "significant" -->

<!-- #plot adjusted p-value significance map for Ii -->
<!-- tm_shape(vehicle_LSOA) + tm_polygons(col="Ii_ad_sig", palette="-RdBu") -->

<!-- ``` -->

```{r}
#mparking <- opq(bbox = 'greater london uk') %>%
#    add_osm_feature(key = 'amenity', value = 'motorcycle_parking')
#cparking <- opq(bbox = 'greater london uk') %>%
#     add_osm_feature(key = 'amenity', value = 'parking')
# parking <- c (mparking, cparking)
# parkingdata <- osmdata_sf(parking)
# 
# industrial <- opq(bbox = 'greater london uk') %>%
#     add_osm_feature(key = 'landuse', value = 'industrial')
# industrialdata <- osmdata_sf(industrial)

# plots industrial areas as polygons

# tmap_mode("view")
# tm_shape(vehicle_census)+ tm_layout("Parking, industrial estates and vehicle crime rates by LSOA") + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents", alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_polygons)+tm_polygons(alpha=0.4)+tm_shape(dat_dropped)+tm_polygons(col='blue', border.col='transparent',alpha=0.4)
# 
# tmap_mode("plot")
# tm_shape(vehicle_census)+ tm_layout("Parking, industrial estates and vehicle crime rates by LSOA") + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents")+tm_shape(parkingdata$osm_points)+tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_polygons)+tm_polygons(alpha=0.4)+tm_shape(dat_dropped)+tm_polygons(col='blue', border.col='transparent',alpha=0.4)


# plots industrial areas as points
#tmap_mode("view")
#tm_shape(vehicle_census)+ tm_layout("Parking, industrial estates and vehicle crime rates by LSOA") + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents", alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_polygons)+tm_polygons(alpha=0.4)+tm_shape(industrialdata$osm_polygons)+tm_dots(col='blue',alpha=0.4)

#tmap_mode("plot")
#tm_shape(vehicle_census)+ tm_layout("Parking, industrial estates and vehicle crime rates by LSOA") + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents")+tm_shape(parkingdata$osm_points)+tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_polygons)+tm_polygons(alpha=0.4)+tm_shape(industrialdata$osm_points)+tm_dots(col='blue',alpha=0.4)

```
<!-- ```{r} -->
<!-- #EXTRA -->
<!-- # count number of industrial POIs in each LSOA -->
<!-- industrialosm <- opq(bbox = 'greater london uk') %>% -->
<!--     add_osm_feature(key = 'landuse', value = 'industrial') %>% -->
<!--     osmdata_xml(filename = 'industrial.osm') -->

<!-- dat <- sf::st_read('industrial.osm', layer = 'multipolygons', quiet = TRUE) -->
<!-- dat_sp <- as(dat, 'Spatial') -->
<!-- dat_sp_transformed <- spTransform(dat_sp, projection) -->

<!-- n.industrial = poly.counts(dat_sp_transformed, LondonLSOA_transformed_vehicle) -->

<!-- tm_shape(vehicle_census)+ tm_layout("Parking, industrial estates and vehicle crime rates by LSOA") + tm_polygons(col="freq_pop", palette="YlOrRd", style = "jenks", border.col='transparent', n=3, title = "Vehicle crime counts per 1000 residents", alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_polygons)+tm_polygons(alpha=0.4)+tm_shape(dat_sp_transformed)+tm_polygons(col='blue', border.col='transparent',alpha=0.4) -->

<!-- choropleth(LondonLSOA_transformed_vehicle,n.industrial) -->

<!-- ``` -->


<!-- Not sure why for Hounslow 008C but other parts of Chiswick seem to be tied to used car shops/car dealers. Other parts also have sainsburys. Although some other areas appear to be purely residential could this be due to High concentration of large carparks -> car thieves in the area -> opportunistic crime? -->

<!-- Neighbouring Hammersmith area appears quite residential but not sure why high vehicle theft rates... -->

<!-- South Kensington/Knightsbridge/parts of Chelsea, HSK, W Ken areas residential but probably because wealthy... -->

<!-- Not sure about central London/covent garden areas (Mayfair because wealthy?). Surprisingly, parts of City of London e.g. Monument/St Pauls'/Barbican/Moorgate area low rates (proper carparks with security?) -->

<!-- Stratford - ASDA superstore, industrial areas -->

<!-- Need to qualify ecological fallacy error - larger regions. but also need to consider that some LSOAs only have 1 crime... -->

<!-- Also need to consider pedestrian counts... high crime count may just be a reflection of high pedestrian counts... -->

<!-- # A closer analysis of Heathrow Airport -->

<!-- ```{r} -->
<!-- #Only for hillingdon -->
<!-- H031A_ll <- dfvehicle[dfvehicle$LSOA.name == 'Hillingdon 031A',] -->
<!-- H031C_ll <- dfvehicle[dfvehicle$LSOA.name == 'Hillingdon 031C',] -->
<!-- H032A_ll <- dfvehicle[dfvehicle$LSOA.name == 'Hillingdon 032A',] -->

<!-- H031A_llxy <- H031A_ll[,c(3,4)] -->
<!-- H031C_llxy <- H031C_ll[,c(3,4)] -->
<!-- H032A_llxy <- H032A_ll[,c(3,4)] -->

<!-- H031A_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Hillingdon 031A',] -->
<!-- H031C_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Hillingdon 031C',] -->
<!-- H032A_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Hillingdon 032A',] -->


<!-- H031A_llvehiclespdf <- SpatialPointsDataFrame(coords = H031A_llxy, data = H031A_ll, proj4string = projection) -->
<!-- H031C_llvehiclespdf <- SpatialPointsDataFrame(coords = H031C_llxy, data = H031C_ll, proj4string = projection) -->
<!-- H032A_llvehiclespdf <- SpatialPointsDataFrame(coords = H032A_llxy, data = H032A_ll, proj4string = projection) -->

<!-- tm_shape(H031A_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(H031A_llvehiclespdf)+ tm_dots(alpha=0.4) +tm_shape(H031C_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(H031C_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(H032A_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(H032A_llvehiclespdf)+ tm_dots(alpha=0.4) -->

<!-- #with carpark -->
<!-- tm_shape(H031A_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(H031A_llvehiclespdf)+ tm_dots(alpha=0.4) +tm_shape(H031C_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(H031C_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(H032A_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(H032A_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(col='red')+tm_shape(parkingdata$osm_polygons)+tm_polygons(col='red') -->

<!-- ``` -->

<!-- # A closer analysis of Richmond -->

<!-- ```{r} -->
<!-- #Only for Richmond -->
<!-- R008B_ll <- dfvehicle[dfvehicle$LSOA.name == 'Richmond upon Thames 008B',] -->


<!-- R008B_llxy <- R008B_ll[,c(3,4)] -->


<!-- R008B_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Richmond upon Thames 008B',] -->



<!-- R008B_llvehiclespdf <- SpatialPointsDataFrame(coords = R008B_llxy, data = R008B_ll, proj4string = projection) -->

<!-- tm_shape(R008B_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(R008B_llvehiclespdf)+ tm_dots(alpha=0.4)  -->

<!-- #with carpark -->
<!-- tm_shape(R008B_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(R008B_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(col='red')+tm_shape(parkingdata$osm_polygons)+tm_polygons(col='red') -->

<!-- ``` -->


<!-- # A closer analysis of Knightsbridge -->

<!-- ```{r} -->
<!-- #Only for Knightsbridge -->
<!-- W019C_ll <- dfvehicle[dfvehicle$LSOA.name == 'Westminster 019C',] -->
<!-- W019E_ll <- dfvehicle[dfvehicle$LSOA.name == 'Westminster 019E',] -->
<!-- KC012A_ll <- dfvehicle[dfvehicle$LSOA.name == 'Kensington and Chelsea 012A',] -->

<!-- W019C_llxy <- W019C_ll[,c(3,4)] -->
<!-- W019E_llxy <- W019E_ll[,c(3,4)] -->
<!-- KC012A_llxy <- KC012A_ll[,c(3,4)] -->

<!-- W019C_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Westminster 019C',] -->
<!-- W019E_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Westminster 019E',] -->
<!-- KC012A_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Kensington and Chelsea 012A',] -->

<!-- W019C_llvehiclespdf <- SpatialPointsDataFrame(coords = W019C_llxy, data = W019C_ll, proj4string = projection) -->
<!-- W019E_llvehiclespdf <- SpatialPointsDataFrame(coords = W019E_llxy, data = W019E_ll, proj4string = projection) -->
<!-- KC012A_llvehiclespdf <- SpatialPointsDataFrame(coords = KC012A_llxy, data = KC012A_ll, proj4string = projection) -->

<!-- tm_shape(W019C_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(W019C_llvehiclespdf)+ tm_dots(alpha=0.4) +tm_shape(W019E_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(W019E_llvehiclespdf)+ tm_dots(alpha=0.4) +tm_shape(KC012A_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(KC012A_llvehiclespdf)+ tm_dots(alpha=0.4) -->

<!-- #with carpark -->
<!-- tm_shape(R008B_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(R008B_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(col='red')+tm_shape(parkingdata$osm_polygons)+tm_polygons(col='red') -->

<!-- ``` -->

<!-- # A closer analysis of East London  -->

<!-- ```{r} -->
<!-- #Only for east london -->
<!-- BD019E_ll <- dfvehicle[dfvehicle$LSOA.name == 'Barking and Dagenham 019E',] -->
<!-- NH33B_ll <- dfvehicle[dfvehicle$LSOA.name == 'Newham 033B',] -->
<!-- BD021E_ll <- dfvehicle[dfvehicle$LSOA.name == 'Barking and Dagenham 021E',] -->

<!-- BD019E_llxy <- BD019E_ll[,c(3,4)] -->
<!-- NH33B_llxy <- NH33B_ll[,c(3,4)] -->
<!-- BD021E_llxy <- BD021E_ll[,c(3,4)] -->

<!-- BD019E_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Barking and Dagenham 019E',] -->
<!-- NH33B_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Newham 033B',] -->
<!-- BD021E_llshp <- LondonLSOA_transformed[LondonLSOA_transformed$LSOA11NM == 'Barking and Dagenham 021E',] -->


<!-- BD019E_llvehiclespdf <- SpatialPointsDataFrame(coords = BD019E_llxy, data = BD019E_ll, proj4string = projection) -->
<!-- NH33B_llvehiclespdf <- SpatialPointsDataFrame(coords = NH33B_llxy, data = NH33B_ll, proj4string = projection) -->
<!-- BD021E_llvehiclespdf <- SpatialPointsDataFrame(coords = BD021E_llxy, data = BD021E_ll, proj4string = projection) -->

<!-- tmap_mode("view") -->
<!-- tm_shape(BD019E_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(BD019E_llvehiclespdf)+ tm_dots(alpha=0.4) +tm_shape(NH33B_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(NH33B_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(BD021E_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(BD021E_llvehiclespdf)+ tm_dots(alpha=0.4) -->

<!-- #with carpark -->
<!-- tm_shape(BD019E_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(BD019E_llvehiclespdf)+ tm_dots(alpha=0.4) +tm_shape(NH33B_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(NH33B_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(BD021E_llshp) + tm_polygons(col='blue', alpha = 0.4)+tm_shape(BD021E_llvehiclespdf)+ tm_dots(alpha=0.4)+tm_shape(parkingdata$osm_points)+tm_dots(col='red')+tm_shape(parkingdata$osm_polygons)+tm_polygons(col='red') -->

<!-- ``` -->

<!-- ## Modelling -->

<!-- summary(vs.durbin) -->
<!-- ``` -->
<!-- **Here are the results** -->
<!-- Significant and negatively correlated:   -->
<!-- X0.15, X16.29, X45.64, X65, person_per_hectare, owned_outright, household_at_least_one_usual_resident, apartment, poor_transport_access                     -->

<!-- Significant and positively correlated:   -->
<!-- Christian, Buddhist, Hindu, Jewish, Muslim, no_religion, private-rented, household_no_usual_resident, unemployment_rate , no_cars_in_household , household_income      -->

<!-- ### Analysing Factors that Contribute to vehicle crime -->
<!-- ```{r} -->
<!-- load(file = "lsoa_census.rda") -->
<!-- vehicle_census <-  LondonLSOA_transformed_vehicle -->
<!-- vehicle_census@data <- left_join(vehicle_census@data, lsoa_census, by=c("LSOA11CD" = "Codes")) -->
<!-- vehicle_census.W <- nb2listw(poly2nb(vehicle_census)) -->
<!-- # run durbin model -->
<!-- vehicle.durbin <- lagsarlm(Freq ~ X0.15 + X16.29 + X30.44 + X45.64 + X65. + Working.age + person_per_hectare + couple_w_children + white + uk_born + household_no_english + Christian + Buddhist + Hindu + Jewish + Muslim + Sikh + other_religion + no_religion + owned_outright + social_rented + private_rented + household_at_least_one_usual_resident + household_no_usual_resident + whole_house + apartment + house_price + unemployment_rate + bad_health + no_cars_in_household + poor_transport_access + household_income, data = vehicle_census@data, listw = vehicle_census.W, type = 'mixed') -->
<!-- summary(vehicle.durbin) -->

<!-- vehicle_census$durbin.res <- residuals(vehicle.durbin) -->
<!-- vehicle_census$durbin.fit <- exp(fitted.values(vehicle.durbin)) -->
<!-- #ggplot(data=boston.shp@data, aes(sample=durbin.res)) + geom_qq() + geom_qq_line() -->
<!-- tm_shape(vehicle_census)+tm_polygons("durbin.res", palette="-RdBu", style="quantile") -->

<!-- ``` -->
<!-- Call:lagsarlm(formula = Freq ~ X0.15 + X16.29 + X30.44 + X45.64 +  -->
<!--     X65. + Working.age + person_per_hectare + couple_w_children +  -->
<!--     white + uk_born + household_no_english + Christian + Buddhist +  -->
<!--     Hindu + Jewish + Muslim + Sikh + other_religion + no_religion +  -->
<!--     owned_outright + social_rented + private_rented + household_at_least_one_usual_resident +  -->
<!--     household_no_usual_resident + whole_house + apartment + house_price +  -->
<!--     unemployment_rate + bad_health + no_cars_in_household + poor_transport_access +  -->
<!--     household_income, data = vehicle_census@data, listw = vehicle_census.W,     type = "mixed") -->

<!-- Residuals: -->
<!--      Min       1Q   Median       3Q      Max  -->
<!-- -54.4349  -6.4456  -1.2971   4.4781 150.6435  -->

<!-- Type: mixed  -->
<!-- Coefficients: (numerical Hessian approximate standard errors)  -->
<!--     (2 not defined because of singularities) -->
<!--                                              Estimate  Std. Error  z value  Pr(>|z|) -->
<!-- (Intercept)                                9.8126e-01          NA       NA        NA -->
<!-- X16.29                                     1.8074e-02  2.4036e-03   7.5195 5.507e-14 -->
<!-- X30.44                                     1.2822e-02  5.4908e-03   2.3352 0.0195355 -->
<!-- person_per_hectare                        -8.8644e-02  4.3354e-03 -20.4467 < 2.2e-16 -->
<!-- white                                      6.8761e-03  2.3354e-03   2.9442 0.0032377 -->
<!-- uk_born                                   -1.4548e-02  2.1446e-03  -6.7835 1.173e-11 -->
<!-- household_no_english                      -4.0367e-02  1.0544e-02  -3.8285 0.0001289 -->
<!-- Hindu                                     -1.4953e-02  2.8444e-03  -5.2570 1.464e-07 -->
<!-- no_religion                               -1.5385e-02  2.7047e-03  -5.6880 1.285e-08 -->
<!-- private_rented                             2.7600e-02  5.4415e-03   5.0722 3.933e-07 -->
<!-- household_at_least_one_usual_resident      1.7044e-02  4.6907e-03   3.6335 0.0002796 -->
<!-- household_no_usual_resident                8.1492e-02  9.4678e-03   8.6073 < 2.2e-16 -->
<!-- apartment                                 -1.5312e-02  2.2545e-03  -6.7920 1.106e-11 -->
<!-- house_price                               -1.6642e-03  5.4228e-04  -3.0690 0.0021477 -->
<!-- unemployment_rate                          1.0443e-01  1.2705e-01   0.8220 0.4110821 -->
<!-- no_cars_in_household                       1.9622e-02  4.7107e-03   4.1653 3.109e-05 -->
<!-- poor_transport_access                     -2.9699e-02  9.1465e-03  -3.2471 0.0011660 -->
<!-- lag.X0.15                                 -2.8073e-02  8.8616e-03  -3.1679 0.0015355 -->
<!-- lag.X16.29                                -3.0780e-02  2.9748e-03 -10.3470 < 2.2e-16 -->
<!-- lag.X30.44                                -6.9140e-03  8.5713e-03  -0.8066 0.4198693 -->
<!-- lag.X65.                                  -3.5627e-02  6.6695e-03  -5.3418 9.204e-08 -->
<!-- lag.person_per_hectare                     2.9417e-02  6.5724e-03   4.4759 7.609e-06 -->
<!-- lag.couple_w_children                     -5.5452e-02  2.2105e-02  -2.5086 0.0121219 -->
<!-- lag.white                                  1.2306e-02  2.8397e-03   4.3334 1.468e-05 -->
<!-- lag.Muslim                                 2.5303e-02  6.0630e-04  41.7338 < 2.2e-16 -->
<!-- lag.Sikh                                   2.2354e-02  5.2089e-03   4.2915 1.775e-05 -->
<!-- lag.private_rented                        -1.0251e-02  8.2718e-03  -1.2393 0.2152247 -->
<!-- lag.household_at_least_one_usual_resident  5.0089e-02  8.0641e-03   6.2113 5.255e-10 -->
<!-- lag.household_no_usual_resident            5.6730e-02  2.3454e-02   2.4188 0.0155720 -->
<!-- lag.whole_house                           -5.9668e-02  1.4610e-02  -4.0841 4.424e-05 -->
<!-- lag.apartment                             -5.3884e-02  1.6824e-02  -3.2028 0.0013610 -->
<!-- lag.unemployment_rate                      2.3898e-01  1.1306e-01   2.1137 0.0345375 -->
<!-- lag.poor_transport_access                  4.0853e-02  1.6146e-02   2.5303 0.0113968 -->

<!-- Rho: 0.44921, LR test value: 579.71, p-value: < 2.22e-16 -->
<!-- Approximate (numerical Hessian) standard error: 0.016542 -->
<!--     z-value: 27.156, p-value: < 2.22e-16 -->
<!-- Wald statistic: 737.47, p-value: < 2.22e-16 -->

<!-- Log likelihood: -18996.41 for mixed model -->
<!-- ML residual variance (sigma squared): 148, (sigma: 12.165) -->
<!-- Number of observations: 4825  -->
<!-- Number of parameters estimated: 65  -->
<!-- AIC: 38123, (AIC for lm: 38701) -->

